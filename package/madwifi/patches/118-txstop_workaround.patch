Index: madwifi-ng-r2420-20070602/ath/if_ath.c
===================================================================
--- madwifi-ng-r2420-20070602.orig/ath/if_ath.c	2007-06-04 13:21:56.713354928 +0200
+++ madwifi-ng-r2420-20070602/ath/if_ath.c	2007-06-04 13:21:56.911324832 +0200
@@ -2242,6 +2242,17 @@
 		txq->axq_link = &lastds->ds_link;
 		ath_hal_txstart(ah, txq->axq_qnum);
 		sc->sc_dev->trans_start = jiffies;
+		if ((sc->sc_opmode == HAL_M_IBSS) || (sc->sc_opmode == HAL_M_HOSTAP)) {
+			if (sc->sc_tx_start && (ath_hal_numtxpending(ah, txq->axq_qnum) > 2)) {
+				if (jiffies > sc->sc_tx_start + 2 * HZ) {
+					printk("%s: Tx queue stuck. Resetting hardware...\n", sc->sc_dev->name);
+					ath_reset(sc->sc_dev);
+					sc->sc_tx_start = 0;
+				}
+			} else {
+				sc->sc_tx_start = jiffies;
+			}
+		}
 	}
 	ATH_TXQ_UNLOCK_IRQ(txq);
 
@@ -7285,6 +7296,7 @@
 			__func__, ds);
 #else
 		ds = bf->bf_desc;		/* NB: last descriptor */
+		sc->sc_tx_start = 0;
 #endif
 		ts = &bf->bf_dsstatus.ds_txstat;
 		status = ath_hal_txprocdesc(ah, ds, ts);
Index: madwifi-ng-r2420-20070602/ath/if_athvar.h
===================================================================
--- madwifi-ng-r2420-20070602.orig/ath/if_athvar.h	2007-06-04 13:21:53.369863216 +0200
+++ madwifi-ng-r2420-20070602/ath/if_athvar.h	2007-06-04 13:21:56.911324832 +0200
@@ -686,6 +686,14 @@
 	u_int sc_slottimeconf;			/* manual override for slottime */
 	int16_t sc_channoise; 			/* Measured noise of current channel (dBm) */
 	u_int64_t sc_tsf;			/* TSF at last rx interrupt */
+
+	/* 
+	 * Several MiniPCI cards and most SoC revs frequently cease all transmission
+	 * when operating in IBSS mode. The reason for this is unknown and could potentially
+	 * be a hardware bug. This variable contains the timestamp of the last successful
+	 * transmission and is checked when enqueueing new frames
+	 */
+	unsigned long sc_tx_start;
 };
 
 typedef void (*ath_callback) (struct ath_softc *);
