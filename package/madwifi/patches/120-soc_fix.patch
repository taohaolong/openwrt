diff -urN madwifi-ng-r2377-20070526.old/ath/if_ath_ahb.c madwifi-ng-r2377-20070526.dev/ath/if_ath_ahb.c
--- madwifi-ng-r2377-20070526.old/ath/if_ath_ahb.c	2007-02-24 02:33:54.000000000 +0100
+++ madwifi-ng-r2377-20070526.dev/ath/if_ath_ahb.c	2007-05-26 18:51:09.112702200 +0200
@@ -275,11 +275,10 @@
 
 
 static int
-exit_ath_wmac(u_int16_t wlanNum)
+exit_ath_wmac(u_int16_t wlanNum, struct ar531x_config *config)
 {
 	struct ath_ahb_softc *sc = sclist[wlanNum];
 	struct net_device *dev;
-	const char *sysType;
 	u_int16_t devid;
 
 	if (sc == NULL)
@@ -290,12 +289,16 @@
 	if (dev->irq)
 		free_irq(dev->irq, dev);
 	sysType = get_system_type();
-	if (!strcmp(sysType, "Atheros AR5315"))
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,19)
+	devid = (u32) config->tag;
+#else
+	if (!strcmp(get_system_type(), "Atheros AR5315"))
 		devid = (u_int16_t) (sysRegRead(AR5315_SREV) &
 			(AR5315_REV_MAJ_M | AR5315_REV_MIN_M));
 	else
 		devid = (u_int16_t) ((sysRegRead(AR531X_REV) >> 8) &
 			(AR531X_REV_MAJ | AR531X_REV_MIN));
+#endif
 
 	ahb_disable_wmac(devid, wlanNum);
 	free_netdev(dev);
@@ -401,7 +404,7 @@
 
 static int ahb_wmac_remove(struct platform_device *pdev)
 {
-	exit_ath_wmac(pdev->id);
+	exit_ath_wmac(pdev->id, (struct ar531x_config *) pdev->dev.platform_data);
 
 	return 0;
 }
@@ -439,7 +442,7 @@
 			(AR5315_REV_MAJ_M | AR5315_REV_MIN_M));
 		if (((devid & AR5315_REV_MAJ_M) == AR5315_REV_MAJ) ||
 			((devid & AR5315_REV_MAJ_M) == AR5317_REV_MAJ))
-			return init_ath_wmac(devid, 0, &config);
+			return init_ath_wmac(devid, 0);
 	}
 
 	devid = (u_int16_t) ((sysRegRead(AR531X_REV) >>8) &
@@ -452,11 +455,11 @@
 		ar5312BspEepromRead(2 * AR531X_RADIO_MASK_OFF, 2,
 			(char *) &radioMask);
 		if ((radioMask & AR531X_RADIO0_MASK) != 0)
-			if ((ret = init_ath_wmac(devid, 0, &config)) !=0 )
+			if ((ret = init_ath_wmac(devid, 0)) !=0 )
 				return ret;
 		/* XXX: Fall through?! */
 	case AR5212_AR2313_REV8:
-		if ((ret = init_ath_wmac(devid, 1, &config)) != 0)
+		if ((ret = init_ath_wmac(devid, 1)) != 0)
 			return ret;
 		break;
 	default:
