From e63585e28192e854707c549547645c669e6daa2a Mon Sep 17 00:00:00 2001
From: Ivo van Doorn <IvDoorn@gmail.com>
Date: Wed, 4 Mar 2009 20:25:43 +0100
Subject: [PATCH] rt2x00: Fix HW crypto offset calculation (rt2800pci)

Signed-off-by: Ivo van Doorn <IvDoorn@gmail.com>
---
 drivers/net/wireless/rt2x00/rt2800pci.c |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

--- a/drivers/net/wireless/rt2x00/rt2800pci.c
+++ b/drivers/net/wireless/rt2x00/rt2800pci.c
@@ -336,7 +336,8 @@ static void rt2800pci_config_wcid_attr(s
 	rt2x00pci_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB,
 			   !!(key->flags & IEEE80211_KEY_FLAG_PAIRWISE));
-	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER, crypto->cipher);
+	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER,
+			   (crypto->cmd == SET_KEY) * crypto->cipher);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX,
 			   (crypto->cmd == SET_KEY) * crypto->bssidx);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, crypto->cipher);
@@ -393,10 +394,11 @@ static int rt2800pci_config_shared_key(s
 	 * Using the correct defines correctly will cause overhead,
 	 * so just calculate the correct offset.
 	 */
-	field.bit_offset = (4 * key->keyidx) + (16 * (crypto->bssidx & 1));
+	field.bit_offset = 4 * (key->hw_key_idx % 8);
 	field.bit_mask = 0x7 << field.bit_offset;
 
-	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 2);
+	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 8);
+
 	rt2x00pci_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, field,
 			   (crypto->cmd == SET_KEY) * crypto->cipher);
