From dde442877db96055110a9c7c55fa1cb95cc1d87e Mon Sep 17 00:00:00 2001
From: Ivo van Doorn <IvDoorn@gmail.com>
Date: Sat, 21 Feb 2009 20:40:23 +0100
Subject: [PATCH] rt2x00: Correctly initialize TXINFO for crypto (rt2800pci)

Signed-off-by: Ivo van Doorn <IvDoorn@gmail.com>
---
 drivers/net/wireless/rt2x00/rt2800pci.c |   22 +++++++++++-----------
 1 files changed, 11 insertions(+), 11 deletions(-)

--- a/drivers/net/wireless/rt2x00/rt2800pci.c
+++ b/drivers/net/wireless/rt2x00/rt2800pci.c
@@ -331,7 +331,7 @@ static void rt2800pci_config_wcid_attr(s
 	u32 offset;
 	u32 reg;
 
-	offset = MAC_WCID_ATTR_ENTRY(crypto->aid);
+	offset = MAC_WCID_ATTR_ENTRY(key->hw_key_idx);
 
 	rt2x00pci_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB,
@@ -342,7 +342,7 @@ static void rt2800pci_config_wcid_attr(s
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, 0);
 	rt2x00pci_register_write(rt2x00dev, offset, reg);
 
-	offset = MAC_IVEIV_ENTRY(crypto->aid);
+	offset = MAC_IVEIV_ENTRY(key->hw_key_idx);
 
 	memset(&iveiv_entry, 0, sizeof(iveiv_entry));
 	if ((crypto->cipher == CIPHER_TKIP) ||
@@ -353,7 +353,7 @@ static void rt2800pci_config_wcid_attr(s
 	rt2x00pci_register_multiwrite(rt2x00dev, offset,
 				      &iveiv_entry, sizeof(iveiv_entry));
 
-	offset = MAC_WCID_ENTRY(crypto->aid);
+	offset = MAC_WCID_ENTRY(key->hw_key_idx);
 
 	memset(&wcid_entry, 0, sizeof(wcid_entry));
 	if (crypto->cmd == SET_KEY)
@@ -393,10 +393,10 @@ static int rt2800pci_config_shared_key(s
 	 * Using the correct defines correctly will cause overhead,
 	 * so just calculate the correct offset.
 	 */
-	field.bit_offset = (4 * key->keyidx);
+	field.bit_offset = (4 * key->keyidx) + (16 * (crypto->bssidx & 1));
 	field.bit_mask = 0x7 << field.bit_offset;
 
-	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 8);
+	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 2);
 	rt2x00pci_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, field,
 			   (crypto->cmd == SET_KEY) * crypto->cipher);
@@ -1813,16 +1813,15 @@ static void rt2800pci_write_tx_desc(stru
 			   test_bit(ENTRY_TXD_GENERATE_SEQ, &txdesc->flags));
 	rt2x00_set_field32(&word, TXWI_W1_BW_WIN_SIZE, txdesc->ba_size);
 	rt2x00_set_field32(&word, TXWI_W1_WIRELESS_CLI_ID,
-			   skbdesc->entry->entry_idx);
+			   test_bit(ENTRY_TXD_ENCRYPT, &txdesc->flags) ?
+			       txdesc->key_idx : 0xff);
 	rt2x00_set_field32(&word, TXWI_W1_MPDU_TOTAL_BYTE_COUNT, skb->len);
 	rt2x00_set_field32(&word, TXWI_W1_PACKETID,
 			   skbdesc->entry->queue->qid);
 	rt2x00_desc_write(txwi, 1, word);
 
-	if (test_bit(ENTRY_TXD_ENCRYPT, &txdesc->flags)) {
-		_rt2x00_desc_write(txwi, 2, skbdesc->iv[0]);
-		_rt2x00_desc_write(txwi, 3, skbdesc->iv[1]);
-	}
+	_rt2x00_desc_write(txwi, 2, 0 /* skbdesc->iv[0] */);
+	_rt2x00_desc_write(txwi, 3, 0 /* skbdesc->iv[1] */);
 
 	/*
 	 * Initialize TX descriptor
@@ -1849,7 +1848,8 @@ static void rt2800pci_write_tx_desc(stru
 	rt2x00_desc_write(txd, 2, word);
 
 	rt2x00_desc_read(txd, 3, &word);
-	rt2x00_set_field32(&word, TXD_W3_WIV, 1);
+	rt2x00_set_field32(&word, TXD_W3_WIV,
+			   !test_bit(ENTRY_TXD_ENCRYPT_IV, &txdesc->flags));
 	rt2x00_set_field32(&word, TXD_W3_QSEL, 2);
 	rt2x00_desc_write(txd, 3, word);
 }
