From d6368d8b77bb8568aa0c92adf1e507fb4198ff41 Mon Sep 17 00:00:00 2001
From: Ivo van Doorn <IvDoorn@gmail.com>
Date: Wed, 4 Mar 2009 20:26:27 +0100
Subject: [PATCH] rt2x00: Fix HW crypto offset calculation (rt2800usb)

Signed-off-by: Ivo van Doorn <IvDoorn@gmail.com>
---
 drivers/net/wireless/rt2x00/rt2800usb.c |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

--- a/drivers/net/wireless/rt2x00/rt2800usb.c
+++ b/drivers/net/wireless/rt2x00/rt2800usb.c
@@ -363,7 +363,8 @@ static void rt2800usb_config_wcid_attr(s
 	rt2x00usb_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB,
 			   !!(key->flags & IEEE80211_KEY_FLAG_PAIRWISE));
-	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER, crypto->cipher);
+	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER,
+			   (crypto->cmd == SET_KEY) * crypto->cipher);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX,
 			   (crypto->cmd == SET_KEY) * crypto->bssidx);
 	rt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, crypto->cipher);
@@ -425,10 +426,10 @@ static int rt2800usb_config_shared_key(s
 	 * Using the correct defines correctly will cause overhead,
 	 * so just calculate the correct offset.
 	 */
-	field.bit_offset = (4 * key->keyidx) + (16 * (crypto->bssidx & 1));
+	field.bit_offset = 4 * (key->hw_key_idx % 8);
 	field.bit_mask = 0x7 << field.bit_offset;
 
-	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 2);
+	offset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 8);
 
 	rt2x00usb_register_read(rt2x00dev, offset, &reg);
 	rt2x00_set_field32(&reg, field,
