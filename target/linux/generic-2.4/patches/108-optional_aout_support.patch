Index: linux-2.4.35.4/Documentation/Configure.help
===================================================================
--- linux-2.4.35.4.orig/Documentation/Configure.help	2007-12-15 05:19:52.251398675 +0100
+++ linux-2.4.35.4/Documentation/Configure.help	2007-12-15 05:19:53.139449282 +0100
@@ -4690,6 +4690,12 @@
   ld.so (check the file <file:Documentation/Changes> for location and
   latest version).
 
+ELF binaries with a.out format interpreters or a.out libraries
+CONFIG_BINFMT_ELF_AOUT
+  The kernel may support ELF executables which use an a.out format
+  interpreter (dynamic linker) and/or a.out shared libraries, in
+  addition to the usual ELF-ELF setups. You shouldn't need this.
+
 Kernel support for a.out binaries
 CONFIG_BINFMT_AOUT
   A.out (Assembler.OUTput) is a set of formats for libraries and
@@ -4703,13 +4709,11 @@
   warrant removing support. However its removal is a good idea if you
   wish to ensure that absolutely none of your programs will use this
   older executable format. If you don't know what to answer at this
-  point then answer Y. If someone told you "You need a kernel with
+  point then answer N. If someone told you "You need a kernel with
   QMAGIC support" then you'll have to say Y here. You may answer M to
   compile a.out support as a module and later load the module when you
   want to use a program or library in a.out format. The module will be
-  called binfmt_aout.o. Saying M or N here is dangerous though,
-  because some crucial programs on your system might still be in A.OUT
-  format.
+  called binfmt_aout.o.
 
 OSF/1 v4 readv/writev compatibility
 CONFIG_OSF4_COMPAT
Index: linux-2.4.35.4/arch/alpha/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/alpha/config.in	2007-12-15 05:19:41.518787058 +0100
+++ linux-2.4.35.4/arch/alpha/config.in	2007-12-15 05:19:53.143449511 +0100
@@ -315,6 +315,9 @@
 fi
 
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 tristate 'Kernel support for Linux/Intel ELF binaries' CONFIG_BINFMT_EM86
 source drivers/parport/Config.in
Index: linux-2.4.35.4/arch/alpha/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/alpha/defconfig	2007-12-15 05:19:41.526787516 +0100
+++ linux-2.4.35.4/arch/alpha/defconfig	2007-12-15 05:19:53.143449511 +0100
@@ -72,6 +72,7 @@
 # CONFIG_KCORE_AOUT is not set
 # CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 # CONFIG_BINFMT_EM86 is not set
 
Index: linux-2.4.35.4/arch/arm/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/arm/config.in	2007-12-15 05:19:41.534787971 +0100
+++ linux-2.4.35.4/arch/arm/config.in	2007-12-15 05:19:53.143449511 +0100
@@ -499,6 +499,9 @@
 	 A.OUT		CONFIG_KCORE_AOUT" ELF
 tristate 'Kernel support for a.out binaries' CONFIG_BINFMT_AOUT
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 dep_bool 'Power Management support (experimental)' CONFIG_PM $CONFIG_EXPERIMENTAL
 dep_tristate 'RISC OS personality' CONFIG_ARTHUR $CONFIG_CPU_32
Index: linux-2.4.35.4/arch/arm/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/arm/defconfig	2007-12-15 05:19:41.542788427 +0100
+++ linux-2.4.35.4/arch/arm/defconfig	2007-12-15 05:19:53.143449511 +0100
@@ -83,8 +83,9 @@
 CONFIG_NWFPE=y
 CONFIG_KCORE_ELF=y
 # CONFIG_KCORE_AOUT is not set
-CONFIG_BINFMT_AOUT=y
+# CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 # CONFIG_PM is not set
 # CONFIG_ARTHUR is not set
Index: linux-2.4.35.4/arch/cris/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/cris/config.in	2007-12-15 05:19:41.550788882 +0100
+++ linux-2.4.35.4/arch/cris/config.in	2007-12-15 05:19:53.143449511 +0100
@@ -31,6 +31,9 @@
 bool 'Sysctl support' CONFIG_SYSCTL
 
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 
 string 'Kernel command line' CONFIG_ETRAX_CMDLINE "root=/dev/mtdblock3"
 
Index: linux-2.4.35.4/arch/cris/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/cris/defconfig	2007-12-15 05:19:41.554789111 +0100
+++ linux-2.4.35.4/arch/cris/defconfig	2007-12-15 05:19:53.147449737 +0100
@@ -18,6 +18,7 @@
 # CONFIG_BSD_PROCESS_ACCT is not set
 # CONFIG_SYSCTL is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_ETRAX_KGDB is not set
 # CONFIG_ETRAX_WATCHDOG is not set
 
Index: linux-2.4.35.4/arch/i386/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/i386/config.in	2007-12-15 05:19:41.562789566 +0100
+++ linux-2.4.35.4/arch/i386/config.in	2007-12-15 05:19:53.147449737 +0100
@@ -329,6 +329,9 @@
 fi
 tristate 'Kernel support for a.out binaries' CONFIG_BINFMT_AOUT
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'Select task to kill on out of memory condition' CONFIG_OOM_KILLER
 
Index: linux-2.4.35.4/arch/i386/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/i386/defconfig	2007-12-15 05:19:41.570790022 +0100
+++ linux-2.4.35.4/arch/i386/defconfig	2007-12-15 05:19:53.147449737 +0100
@@ -115,9 +115,10 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 # CONFIG_KCORE_AOUT is not set
-CONFIG_BINFMT_AOUT=y
+# CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
-CONFIG_BINFMT_MISC=y
+# CONFIG_BINFMT_ELF_AOUT is not set
+# CONFIG_BINFMT_MISC is not set
 # CONFIG_OOM_KILLER is not set
 CONFIG_PM=y
 # CONFIG_APM is not set
Index: linux-2.4.35.4/arch/ia64/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/ia64/config.in	2007-12-15 05:19:41.578790477 +0100
+++ linux-2.4.35.4/arch/ia64/config.in	2007-12-15 05:19:53.147449737 +0100
@@ -124,6 +124,9 @@
 bool 'BSD Process Accounting' CONFIG_BSD_PROCESS_ACCT
 bool 'Sysctl support' CONFIG_SYSCTL
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 
 if [ "$CONFIG_IA64_HP_SIM" = "n" ]; then
Index: linux-2.4.35.4/arch/ia64/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/ia64/defconfig	2007-12-15 05:19:41.586790935 +0100
+++ linux-2.4.35.4/arch/ia64/defconfig	2007-12-15 05:19:53.151449966 +0100
@@ -60,6 +60,7 @@
 # CONFIG_BSD_PROCESS_ACCT is not set
 CONFIG_SYSCTL=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 CONFIG_ACPI=y
 CONFIG_ACPI_EFI=y
Index: linux-2.4.35.4/arch/m68k/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/m68k/config.in	2007-12-15 05:19:41.594791391 +0100
+++ linux-2.4.35.4/arch/m68k/config.in	2007-12-15 05:19:53.151449966 +0100
@@ -99,6 +99,9 @@
 fi
 tristate 'Kernel support for a.out binaries' CONFIG_BINFMT_AOUT
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 
 if [ "$CONFIG_AMIGA" = "y" ]; then
Index: linux-2.4.35.4/arch/m68k/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/m68k/defconfig	2007-12-15 05:19:41.602791846 +0100
+++ linux-2.4.35.4/arch/m68k/defconfig	2007-12-15 05:19:53.151449966 +0100
@@ -44,8 +44,9 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 # CONFIG_KCORE_AOUT is not set
-CONFIG_BINFMT_AOUT=y
+# CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 CONFIG_ZORRO=y
 # CONFIG_AMIGA_PCMCIA is not set
Index: linux-2.4.35.4/arch/mips/config-shared.in
===================================================================
--- linux-2.4.35.4.orig/arch/mips/config-shared.in	2007-12-15 05:19:44.814974898 +0100
+++ linux-2.4.35.4/arch/mips/config-shared.in	2007-12-15 05:19:53.151449966 +0100
@@ -873,6 +873,9 @@
 define_bool CONFIG_KCORE_AOUT n
 define_bool CONFIG_BINFMT_AOUT n
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 dep_bool 'Kernel support for Linux/MIPS 32-bit binary compatibility' CONFIG_MIPS32_COMPAT $CONFIG_MIPS64
 dep_bool 'Kernel support for o32 binaries' CONFIG_MIPS32_O32 $CONFIG_MIPS32_COMPAT
 dep_bool 'Kernel support for n32 binaries' CONFIG_MIPS32_N32 $CONFIG_MIPS32_COMPAT
Index: linux-2.4.35.4/arch/mips/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/mips/defconfig	2007-12-15 05:19:44.814974898 +0100
+++ linux-2.4.35.4/arch/mips/defconfig	2007-12-15 05:19:53.155450196 +0100
@@ -143,6 +143,7 @@
 # CONFIG_KCORE_AOUT is not set
 # CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_MIPS32_COMPAT is not set
 # CONFIG_MIPS32_O32 is not set
 # CONFIG_MIPS32_N32 is not set
Index: linux-2.4.35.4/arch/mips/kernel/irixelf.c
===================================================================
--- linux-2.4.35.4.orig/arch/mips/kernel/irixelf.c	2007-12-15 05:19:41.626793215 +0100
+++ linux-2.4.35.4/arch/mips/kernel/irixelf.c	2007-12-15 05:19:53.155450196 +0100
@@ -8,6 +8,7 @@
  * Copyright 1993, 1994: Eric Youngdale (ericy@cais.com).
  */
 
+#include <linux/config.h>
 #include <linux/module.h>
 
 #include <linux/fs.h>
@@ -48,7 +49,12 @@
 extern int dump_fpu (elf_fpregset_t *);
 
 static struct linux_binfmt irix_format = {
-	NULL, THIS_MODULE, load_irix_binary, load_irix_library,
+	NULL, THIS_MODULE, load_irix_binary,
+#ifdef CONFIG_BINFMT_ELF_AOUT
+	load_irix_library,
+#else
+	NULL,
+#endif
 	irix_core_dump, PAGE_SIZE
 };
 
@@ -794,6 +800,7 @@
 	goto out;
 }
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 /* This is really simpleminded and specialized - we are loading an
  * a.out library that is given an ELF header.
  */
@@ -873,6 +880,7 @@
 	kfree(elf_phdata);
 	return 0;
 }
+#endif
 
 /* Called through irix_syssgi() to map an elf image given an FD,
  * a phdr ptr USER_PHDRP in userspace, and a count CNT telling how many
Index: linux-2.4.35.4/arch/mips64/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/mips64/defconfig	2007-12-15 05:19:44.874978317 +0100
+++ linux-2.4.35.4/arch/mips64/defconfig	2007-12-15 05:19:53.155450196 +0100
@@ -147,6 +147,7 @@
 # CONFIG_KCORE_AOUT is not set
 # CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 CONFIG_MIPS32_COMPAT=y
 CONFIG_MIPS32_O32=y
 # CONFIG_MIPS32_N32 is not set
Index: linux-2.4.35.4/arch/parisc/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/parisc/config.in	2007-12-15 05:19:41.638793897 +0100
+++ linux-2.4.35.4/arch/parisc/config.in	2007-12-15 05:19:53.155450196 +0100
@@ -89,6 +89,9 @@
 bool 'Sysctl support' CONFIG_SYSCTL
 define_bool CONFIG_KCORE_ELF y
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for SOM binaries' CONFIG_BINFMT_SOM
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 
Index: linux-2.4.35.4/arch/parisc/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/parisc/defconfig	2007-12-15 05:19:41.646794355 +0100
+++ linux-2.4.35.4/arch/parisc/defconfig	2007-12-15 05:19:53.159450422 +0100
@@ -56,6 +56,7 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 CONFIG_BINFMT_SOM=y
 # CONFIG_BINFMT_MISC is not set
 # CONFIG_PM is not set
Index: linux-2.4.35.4/arch/ppc/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/ppc/config.in	2007-12-15 05:19:41.654794810 +0100
+++ linux-2.4.35.4/arch/ppc/config.in	2007-12-15 05:19:53.159450422 +0100
@@ -384,6 +384,7 @@
 fi
 define_bool CONFIG_BINFMT_ELF y
 define_bool CONFIG_KERNEL_ELF y
+bool 'ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'Select task to kill on out of memory condition' CONFIG_OOM_KILLER
 
Index: linux-2.4.35.4/arch/ppc/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/ppc/defconfig	2007-12-15 05:19:41.662795265 +0100
+++ linux-2.4.35.4/arch/ppc/defconfig	2007-12-15 05:19:53.159450422 +0100
@@ -59,7 +59,8 @@
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
 CONFIG_KERNEL_ELF=y
-CONFIG_BINFMT_MISC=m
+# CONFIG_BINFMT_ELF_AOUT is not set
+# CONFIG_BINFMT_MISC is not set
 # CONFIG_OOM_KILLER is not set
 CONFIG_PCI_NAMES=y
 CONFIG_HOTPLUG=y
Index: linux-2.4.35.4/arch/ppc64/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/ppc64/config.in	2007-12-15 05:19:41.670795721 +0100
+++ linux-2.4.35.4/arch/ppc64/config.in	2007-12-15 05:19:53.159450422 +0100
@@ -82,6 +82,9 @@
 fi
 
 bool 'Kernel support for 64 bit ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 
 tristate 'Kernel support for 32 bit ELF binaries' CONFIG_BINFMT_ELF32
 
Index: linux-2.4.35.4/arch/ppc64/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/ppc64/defconfig	2007-12-15 05:19:41.678796176 +0100
+++ linux-2.4.35.4/arch/ppc64/defconfig	2007-12-15 05:19:53.163450651 +0100
@@ -56,6 +56,7 @@
 # CONFIG_BSD_PROCESS_ACCT is not set
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 CONFIG_BINFMT_ELF32=y
 # CONFIG_BINFMT_MISC is not set
 CONFIG_PCI_NAMES=y
Index: linux-2.4.35.4/arch/s390/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/s390/config.in	2007-12-15 05:19:41.686796634 +0100
+++ linux-2.4.35.4/arch/s390/config.in	2007-12-15 05:19:53.163450651 +0100
@@ -58,6 +58,9 @@
 bool 'Sysctl support' CONFIG_SYSCTL
 define_bool CONFIG_KCORE_ELF y
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'Show crashed user process info' CONFIG_PROCESS_DEBUG
 bool 'Pseudo page fault support' CONFIG_PFAULT
Index: linux-2.4.35.4/arch/s390/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/s390/defconfig	2007-12-15 05:19:41.694797090 +0100
+++ linux-2.4.35.4/arch/s390/defconfig	2007-12-15 05:19:53.163450651 +0100
@@ -46,6 +46,7 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 # CONFIG_PROCESS_DEBUG is not set
 CONFIG_PFAULT=y
Index: linux-2.4.35.4/arch/s390x/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/s390x/config.in	2007-12-15 05:19:41.698797316 +0100
+++ linux-2.4.35.4/arch/s390x/config.in	2007-12-15 05:19:53.163450651 +0100
@@ -61,6 +61,9 @@
 bool 'Sysctl support' CONFIG_SYSCTL
 define_bool CONFIG_KCORE_ELF y
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'Show crashed user process info' CONFIG_PROCESS_DEBUG
 bool 'Pseudo page fault support' CONFIG_PFAULT
Index: linux-2.4.35.4/arch/s390x/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/s390x/defconfig	2007-12-15 05:19:41.706797774 +0100
+++ linux-2.4.35.4/arch/s390x/defconfig	2007-12-15 05:19:53.163450651 +0100
@@ -47,6 +47,7 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 # CONFIG_PROCESS_DEBUG is not set
 CONFIG_PFAULT=y
Index: linux-2.4.35.4/arch/sh/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/sh/config.in	2007-12-15 05:19:41.714798229 +0100
+++ linux-2.4.35.4/arch/sh/config.in	2007-12-15 05:19:53.163450651 +0100
@@ -283,6 +283,9 @@
 	 A.OUT		CONFIG_KCORE_AOUT" ELF
 fi
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 
 bool 'Select task to kill on out of memory condition' CONFIG_OOM_KILLER
Index: linux-2.4.35.4/arch/sh/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/sh/defconfig	2007-12-15 05:19:41.722798685 +0100
+++ linux-2.4.35.4/arch/sh/defconfig	2007-12-15 05:19:53.167450880 +0100
@@ -48,6 +48,7 @@
 CONFIG_KCORE_ELF=y
 # CONFIG_KCORE_AOUT is not set
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 
 #
Index: linux-2.4.35.4/arch/sparc/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/sparc/config.in	2007-12-15 05:19:41.730799140 +0100
+++ linux-2.4.35.4/arch/sparc/config.in	2007-12-15 05:19:53.167450880 +0100
@@ -74,6 +74,9 @@
 fi
 tristate 'Kernel support for a.out binaries' CONFIG_BINFMT_AOUT
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'SunOS binary emulation' CONFIG_SUNOS_EMUL
 bool 'Select task to kill on out of memory condition' CONFIG_OOM_KILLER
Index: linux-2.4.35.4/arch/sparc/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/sparc/defconfig	2007-12-15 05:19:41.738799596 +0100
+++ linux-2.4.35.4/arch/sparc/defconfig	2007-12-15 05:19:53.167450880 +0100
@@ -49,9 +49,10 @@
 # CONFIG_BSD_PROCESS_ACCT is not set
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
-CONFIG_BINFMT_AOUT=y
+# CONFIG_BINFMT_AOUT is not set
 CONFIG_BINFMT_ELF=y
-CONFIG_BINFMT_MISC=m
+# CONFIG_BINFMT_ELF_AOUT is not set
+# CONFIG_BINFMT_MISC is not set
 CONFIG_SUNOS_EMUL=y
 # CONFIG_OOM_KILLER is not set
 
Index: linux-2.4.35.4/arch/sparc64/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/sparc64/config.in	2007-12-15 05:19:41.742799824 +0100
+++ linux-2.4.35.4/arch/sparc64/config.in	2007-12-15 05:19:53.167450880 +0100
@@ -79,6 +79,9 @@
    bool '  Kernel support for 32-bit (ie. SunOS) a.out binaries' CONFIG_BINFMT_AOUT32
 fi
 bool 'Kernel support for 64-bit ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 bool 'SunOS binary emulation' CONFIG_SUNOS_EMUL
 if [ "$CONFIG_EXPERIMENTAL" = "y" ]; then
Index: linux-2.4.35.4/arch/sparc64/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/sparc64/defconfig	2007-12-15 05:19:41.750800280 +0100
+++ linux-2.4.35.4/arch/sparc64/defconfig	2007-12-15 05:19:53.167450880 +0100
@@ -70,7 +70,8 @@
 CONFIG_BINFMT_ELF32=y
 # CONFIG_BINFMT_AOUT32 is not set
 CONFIG_BINFMT_ELF=y
-CONFIG_BINFMT_MISC=m
+# CONFIG_BINFMT_ELF_AOUT is not set
+# CONFIG_BINFMT_MISC is not set
 # CONFIG_SUNOS_EMUL is not set
 CONFIG_SOLARIS_EMUL=m
 # CONFIG_OOM_KILLER is not set
Index: linux-2.4.35.4/arch/x86_64/config.in
===================================================================
--- linux-2.4.35.4.orig/arch/x86_64/config.in	2007-12-15 05:19:41.758800735 +0100
+++ linux-2.4.35.4/arch/x86_64/config.in	2007-12-15 05:19:53.171451107 +0100
@@ -118,6 +118,9 @@
 fi
 #tristate 'Kernel support for a.out binaries' CONFIG_BINFMT_AOUT
 bool 'Kernel support for ELF binaries' CONFIG_BINFMT_ELF
+if [ "$CONFIG_BINFMT_ELF" != "n" ]; then
+   bool '  ELF binaries with a.out format interpreters or a.out libraries' CONFIG_BINFMT_ELF_AOUT
+fi
 tristate 'Kernel support for MISC binaries' CONFIG_BINFMT_MISC
 
 bool 'Power Management support' CONFIG_PM
Index: linux-2.4.35.4/arch/x86_64/defconfig
===================================================================
--- linux-2.4.35.4.orig/arch/x86_64/defconfig	2007-12-15 05:19:41.766801193 +0100
+++ linux-2.4.35.4/arch/x86_64/defconfig	2007-12-15 05:19:53.171451107 +0100
@@ -67,6 +67,7 @@
 CONFIG_SYSCTL=y
 CONFIG_KCORE_ELF=y
 CONFIG_BINFMT_ELF=y
+# CONFIG_BINFMT_ELF_AOUT is not set
 # CONFIG_BINFMT_MISC is not set
 CONFIG_PM=y
 CONFIG_IA32_EMULATION=y
Index: linux-2.4.35.4/fs/binfmt_elf.c
===================================================================
--- linux-2.4.35.4.orig/fs/binfmt_elf.c	2007-12-15 05:19:45.006985841 +0100
+++ linux-2.4.35.4/fs/binfmt_elf.c	2007-12-15 05:19:53.171451107 +0100
@@ -9,6 +9,7 @@
  * Copyright 1993, 1994: Eric Youngdale (ericy@cais.com).
  */
 
+#include <linux/config.h>
 #include <linux/module.h>
 
 #include <linux/fs.h>
@@ -43,7 +44,9 @@
 #include <linux/elf.h>
 
 static int load_elf_binary(struct linux_binprm * bprm, struct pt_regs * regs);
+#ifdef CONFIG_BINFMT_ELF_AOUT
 static int load_elf_library(struct file*);
+#endif
 static unsigned long elf_map (struct file *, unsigned long, struct elf_phdr *, int, int);
 extern int dump_fpu (struct pt_regs *, elf_fpregset_t *);
 extern void dump_thread(struct pt_regs *, struct user *);
@@ -74,7 +77,13 @@
 #define ELF_PAGEALIGN(_v) (((_v) + ELF_MIN_ALIGN - 1) & ~(ELF_MIN_ALIGN - 1))
 
 static struct linux_binfmt elf_format = {
-	NULL, THIS_MODULE, load_elf_binary, load_elf_library, elf_core_dump, ELF_EXEC_PAGESIZE
+	NULL, THIS_MODULE, load_elf_binary,
+#ifdef CONFIG_BINFMT_ELF_AOUT
+	load_elf_library,
+#else
+	NULL,
+#endif
+	elf_core_dump, ELF_EXEC_PAGESIZE
 };
 
 #define BAD_ADDR(x)	((unsigned long)(x) >= TASK_SIZE)
@@ -404,6 +413,7 @@
 	return error;
 }
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 static unsigned long load_aout_interp(struct exec * interp_ex,
 			     struct file * interpreter)
 {
@@ -451,6 +461,7 @@
 out:
 	return elf_entry;
 }
+#endif
 
 /*
  * These are the functions used to load ELF style executables and shared
@@ -458,7 +469,9 @@
  */
 
 #define INTERPRETER_NONE 0
+#ifdef CONFIG_BINFMT_ELF_AOUT
 #define INTERPRETER_AOUT 1
+#endif
 #define INTERPRETER_ELF 2
 
 
@@ -482,7 +495,9 @@
 	struct elfhdr elf_ex;
 	struct elfhdr interp_elf_ex;
   	struct exec interp_ex;
+#ifdef CONFIG_BINFMT_ELF_AOUT
 	char passed_fileno[6];
+#endif
 	struct files_struct *files;
 	
 	/* Get the exec-header */
@@ -612,6 +627,7 @@
 
 	/* Some simple consistency checks for the interpreter */
 	if (elf_interpreter) {
+#ifdef CONFIG_BINFMT_ELF_AOUT
 		interpreter_type = INTERPRETER_ELF | INTERPRETER_AOUT;
 
 		/* Now figure out which format our binary is */
@@ -619,6 +635,9 @@
 		    (N_MAGIC(interp_ex) != ZMAGIC) &&
 		    (N_MAGIC(interp_ex) != QMAGIC))
 			interpreter_type = INTERPRETER_ELF;
+#else
+		interpreter_type = INTERPRETER_ELF;
+#endif
 
 		if (memcmp(interp_elf_ex.e_ident, ELFMAG, SELFMAG) != 0)
 			interpreter_type &= ~INTERPRETER_ELF;
@@ -627,6 +646,7 @@
 		if (!interpreter_type)
 			goto out_free_dentry;
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 		/* Make sure only one type was selected */
 		if ((interpreter_type & INTERPRETER_ELF) &&
 		     interpreter_type != INTERPRETER_ELF) {
@@ -634,6 +654,7 @@
 			// printk(KERN_WARNING "ELF: Ambiguous type, using ELF\n");
 			interpreter_type = INTERPRETER_ELF;
 		}
+#endif
 		/* Verify the interpreter has a valid arch */
 		if ((interpreter_type == INTERPRETER_ELF) &&
 		    !elf_check_arch(&interp_elf_ex))
@@ -651,6 +672,7 @@
 	/* OK, we are done with that, now set up the arg stuff,
 	   and then start this sucker up */
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 	if (!bprm->sh_bang) {
 		char * passed_p;
 
@@ -669,6 +691,7 @@
 		/* Executables without an interpreter also need a personality  */
 		SET_PERSONALITY(elf_ex, ibcs2_interpreter);
 	}
+#endif
 
 	/* Flush all traces of the currently running executable */
 	retval = flush_old_exec(bprm);
@@ -817,10 +840,12 @@
 	padzero(elf_bss);
 
 	if (elf_interpreter) {
+#ifdef CONFIG_BINFMT_ELF_AOUT
 		if (interpreter_type == INTERPRETER_AOUT)
 			elf_entry = load_aout_interp(&interp_ex,
 						     interpreter);
 		else
+#endif
 			elf_entry = load_elf_interp(&interp_elf_ex,
 						    interpreter,
 						    &interp_load_addr);
@@ -849,7 +874,9 @@
 
 	kfree(elf_phdata);
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 	if (interpreter_type != INTERPRETER_AOUT)
+#endif
 		sys_close(elf_exec_fileno);
 
 	set_binfmt(&elf_format);
@@ -863,10 +890,14 @@
 			&elf_ex,
 			load_addr, load_bias,
 			interp_load_addr,
+#ifdef CONFIG_BINFMT_ELF_AOUT
 			(interpreter_type == INTERPRETER_AOUT ? 0 : 1));
 	/* N.B. passed_fileno might not be initialized? */
 	if (interpreter_type == INTERPRETER_AOUT)
 		current->mm->arg_start += strlen(passed_fileno) + 1;
+#else
+			1);
+#endif
 	current->mm->start_brk = current->mm->brk = elf_brk;
 	current->mm->end_code = end_code;
 	current->mm->start_code = start_code;
@@ -937,9 +968,9 @@
 	goto out;
 }
 
+#ifdef CONFIG_BINFMT_ELF_AOUT
 /* This is really simpleminded and specialized - we are loading an
    a.out library that is given an ELF header. */
-
 static int load_elf_library(struct file *file)
 {
 	struct elf_phdr *elf_phdata;
@@ -1016,6 +1047,7 @@
 out:
 	return error;
 }
+#endif
 
 /*
  * Note that some platforms still use traditional core dumps and not
Index: linux-2.4.35.4/fs/exec.c
===================================================================
--- linux-2.4.35.4.orig/fs/exec.c	2007-12-15 05:19:41.786802333 +0100
+++ linux-2.4.35.4/fs/exec.c	2007-12-15 05:19:53.175451333 +0100
@@ -109,6 +109,7 @@
  */
 asmlinkage long sys_uselib(const char * library)
 {
+#if defined(CONFIG_BINFMT_AOUT) || defined(CONFIG_BINFMT_ELF_AOUT)
 	struct file * file;
 	struct nameidata nd;
 	int error;
@@ -155,6 +156,9 @@
 exit:
 	path_release(&nd);
 	goto out;
+#else
+	return -ENOSYS;
+#endif
 }
 
 /*
