#!/bin/sh
# Copyright (C) 2006 OpenWrt.org
. /etc/functions.sh

is_dirty() {
	mtdpart="$(find_mtd_part linux)"
	grep Broadcom /proc/cpuinfo >&- || return 1
	OFFSET="$(($(hexdump -v $mtdpart -s 20 -n 2 -e '"%d"')-1))"
	return $(hexdump -v $mtdpart -s $OFFSET -n 1 -e '"%d"')
}

if grep devfs /proc/filesystems > /dev/null; then
	mount none /dev -t devfs
else
	mount -t sysfs none /sys
	mount -t tmpfs tmpfs /dev -o size=512K
	mknod /dev/console c 5 1
	mkdir /dev/shm
	/sbin/mdev -s
fi
mkdir -p /dev/pts
mount none /dev/pts -t devpts

if [ "$1" != "failsafe" ]; then 
	mtd unlock linux
	mount | grep jffs2 >&-
	if [ $? = 0 ] ; then
		mount -o remount,rw /dev/root /
	else
		. /bin/firstboot
		is_dirty 
		[ $? != 0 ] && {
			echo "switching to jffs2"
			mount $(find_mtd_part OpenWrt) /jffs -t jffs2
			fopivot /jffs /rom
		} || {
			echo "jffs2 not ready yet; using ramdisk"
			ramoverlay
		}
	fi
fi

grep sysfs /proc/filesystems >/dev/null && mount -t sysfs none /sys 2>&-
