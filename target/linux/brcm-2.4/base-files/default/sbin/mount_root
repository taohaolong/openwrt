#!/bin/sh
# Copyright (C) 2006 OpenWrt.org
. /etc/functions.sh

is_dirty() {
	mtdpart="$(find_mtd_part linux)"
	grep Broadcom /proc/cpuinfo >&- || return 1
	OFFSET="$(($(hexdump -v $mtdpart -s 20 -n 2 -e '"%d"')-1))"
	return $(hexdump -v $mtdpart -s $OFFSET -n 1 -e '"%d"')
}

if [ "$1" != "failsafe" ]; then 
	mtd unlock linux
	mount | grep jffs2 >&-
	if [ $? = 0 ] ; then
		mount -o remount,rw /dev/root /
	else
		. /bin/firstboot
		is_dirty 
		[ $? != 0 ] && {
			echo "switching to jffs2"
			mount $(find_mtd_part OpenWrt) /jffs -t jffs2
			fopivot /jffs /rom
		} || {
			echo "jffs2 not ready yet; using ramdisk"
			ramoverlay
		}
	fi
fi
